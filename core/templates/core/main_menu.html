{% extends "core/base.html" %}
{% load static i18n %}

{% block title %}الرئيسية — متواتر{% endblock %}

{% if IS_ALPHA %}
<div id="alpha-banner" class="alpha-banner" role="status">
  هذه نسخة <strong>{{ APP_VERSION }}</strong> — ما زلنا نُحسّن التجربة. لو قابلتك مشكلة
  <a href="{% url 'core:complaint' %}">بلغّنا من هنا</a>.
  <button id="alpha-dismiss" type="button" aria-label="إغلاق">×</button>
</div>
{% endif %}

{% block content %}
<style>
  /* إخفاء تحية النافبار في صفحة الهوم فقط */
  .nav-welcome, #nav-welcome, .top-welcome { display:none !important; }

  .home-shell{min-height:72vh; display:grid; align-content:start; gap:1.5rem}
  .welcome{
    text-align:center;
    padding:1.8rem 1.5rem 1.2rem;
    border-radius:20px;
    border:1px solid rgba(212,175,55,.25);
    background: linear-gradient(135deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    box-shadow: 0 20px 50px rgba(0,0,0,.3);
    backdrop-filter: blur(10px);
  }
  .welcome h1{
    margin:.3rem 0 .6rem; color:#fff; font-weight:900; letter-spacing:.3px; font-size:clamp(22px,3.5vw,28px);
    text-shadow: 0 2px 4px rgba(0,0,0,.3);
  }
  .welcome .lead{ color:var(--muted); max-width:820px; margin:.3rem auto 0; font-size:1.05rem; }

  .chip{
    display:inline-flex;align-items:center;gap:.5rem;
    direction: rtl;
    font-weight:800; color:#1b1b1b;
    background:linear-gradient(135deg,var(--accent),var(--accent-2));
    padding:.5rem .8rem; border-radius:999px; border:1px solid rgba(212,175,55,.6);
    box-shadow: 0 4px 16px rgba(212,175,55,.3);
    transition: all .3s ease;
  }
  .chip:hover{
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(212,175,55,.4);
  }
  .chip .dot{
    width:12px;height:12px;border-radius:50%;
    background:#16a34a;
    box-shadow:0 0 0 6px rgba(22,163,74,.15);
    animation:pulse 1.8s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{ box-shadow:0 0 0 6px rgba(22,163,74,.15) }
    50%{ box-shadow:0 0 0 9px rgba(22,163,74,.30) }
  }
  .badge-medal{margin-inline-start:.5rem; font-weight:900}

  .home-cta{display:flex; gap:.8rem; justify-content:center; flex-wrap:wrap; margin-top:1.2rem}
  .btn-lg{padding:1rem 1.3rem; border-radius:14px; font-weight:900; transition: all .3s ease; position: relative; overflow: hidden}
  .btn-lg::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transition:left .5s ease}
  .btn-lg:hover::before{left:100%}
  .btn-lg:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.3)}

  .grid-cards{display:grid; grid-template-columns:repeat(3,1fr); gap:1.1rem}
  @media (max-width: 900px){ .grid-cards{grid-template-columns:1fr} }
  
  .grid-cards-two{display:grid; grid-template-columns:repeat(2,1fr); gap:1.1rem; margin-top:1.5rem}
  @media (max-width: 900px){ .grid-cards-two{grid-template-columns:1fr} }
  
  @media (max-width: 480px) {
    .home-shell {
      gap: 1rem;
    }
    
    .welcome {
      padding: 1.4rem 1.2rem 1rem;
    }
    
    .welcome h1 {
      font-size: clamp(20px, 4vw, 24px);
    }
    
    .welcome .lead {
      font-size: 0.95rem;
    }
    
    .cardx {
      padding: 1.2rem 1.1rem;
    }
    
    .cardx h3 {
      font-size: 1rem;
    }
    
    .cardx p {
      font-size: 0.9rem;
    }
    
    .btn-lg {
      padding: 0.8rem 1.1rem;
      font-size: 0.9rem;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
      gap: 0.6rem;
    }
    
    .stat {
      padding: 0.6rem 0.7rem;
    }
  }
  
  @media (max-width: 320px) {
    .welcome {
      padding: 1.2rem 1rem 0.8rem;
    }
    
    .welcome h1 {
      font-size: clamp(18px, 4.5vw, 22px);
    }
    
    .welcome .lead {
      font-size: 0.9rem;
    }
    
    .cardx {
      padding: 1rem 0.9rem;
    }
    
    .cardx h3 {
      font-size: 0.95rem;
    }
    
    .cardx p {
      font-size: 0.85rem;
    }
    
    .btn-lg {
      padding: 0.7rem 1rem;
      font-size: 0.85rem;
    }
    
    .chip {
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
    }
  }
  .cardx{
    position:relative;
    background:linear-gradient(135deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.12);
    border-radius:20px; padding:1.4rem 1.3rem;
    box-shadow:0 16px 40px rgba(0,0,0,.25);
    display:grid; gap:.6rem;
    transition: all .3s ease;
    backdrop-filter: blur(10px);
  }
  .cardx:hover{
    transform: translateY(-3px);
    box-shadow: 0 20px 50px rgba(0,0,0,.35);
  }
  .cardx h3{margin:0; color:#fff; font-weight:900; font-size:1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,.3)}
  .cardx p{margin:0; color:var(--muted); font-size:.95rem}
  .cardx .go{justify-self:start; margin-top:.4rem}

  /* إحصائيات محسنة */
  .stats-grid{
    display:grid; grid-template-columns:repeat(4,1fr); gap:.8rem; margin:.3rem 0 .5rem;
  }
  @media(max-width:700px){ .stats-grid{grid-template-columns:repeat(2,1fr)} }
  .stat{
    background:linear-gradient(135deg, #0f1118, rgba(255,255,255,.02)); 
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px; padding:.8rem .8rem; text-align:center;
    box-shadow:0 12px 32px rgba(0,0,0,.25);
    transition: all .3s ease;
    position: relative;
    overflow: hidden;
  }
  .stat::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.05),transparent);transition:left .5s ease}
  .stat:hover::before{left:100%}
  .stat:hover{transform:translateY(-2px);box-shadow:0 16px 40px rgba(0,0,0,.35)}
  .stat .num{display:block; font-weight:900; font-size:clamp(18px,4vw,24px); color:#fff}
  .stat .lbl{display:block; font-weight:800; color:#9aa3b2; margin-top:.15rem; font-size:.95rem}

  /* ===== انيميشن ظهور العناصر ===== */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(30px);
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .animate-on-scroll.animate-in {
    opacity: 1;
    transform: translateY(0);
  }
  
  /* تأخير مختلف لكل عنصر */
  .animate-delay-1 { transition-delay: 0.1s; }
  .animate-delay-2 { transition-delay: 0.2s; }
  .animate-delay-3 { transition-delay: 0.3s; }
  .animate-delay-4 { transition-delay: 0.4s; }
  .animate-delay-5 { transition-delay: 0.5s; }
  .animate-delay-6 { transition-delay: 0.6s; }
  
  /* انيميشن للبطاقات */
  .card-animate {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .card-animate.animate-in {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  
  /* انيميشن للإحصائيات */
  .stat-animate {
    opacity: 0;
    transform: translateY(20px) rotateX(15deg);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .stat-animate.animate-in {
    opacity: 1;
    transform: translateY(0) rotateX(0deg);
  }
  
  /* انيميشن للأزرار */
  .btn-animate {
    opacity: 0;
    transform: translateY(25px) scale(0.9);
    transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .btn-animate.animate-in {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  
  /* انيميشن للترحيب */
  .welcome-animate {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
    transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .welcome-animate.animate-in {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  
  /* تأثيرات إضافية */
  .fade-in-up {
    animation: fadeInUp 0.8s ease-out forwards;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .bounce-in {
    animation: bounceIn 0.8s ease-out forwards;
  }
  
  @keyframes bounceIn {
    0% {
      opacity: 0;
      transform: scale(0.3);
    }
    50% {
      opacity: 1;
      transform: scale(1.05);
    }
    70% {
      transform: scale(0.9);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  .slide-in-left {
    animation: slideInLeft 0.8s ease-out forwards;
  }
  
  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  .slide-in-right {
    animation: slideInRight 0.8s ease-out forwards;
  }
  
  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .title-underline{
    height:3px; background:linear-gradient(90deg, transparent, var(--accent), transparent);
    border-radius:3px; margin:.4rem auto 0; width:200px; opacity:.7;
  }

  .about{
    margin-top:1.2rem;
    background:linear-gradient(135deg, #fff8ec25, #f3efe625);
    border-inline-start:8px solid var(--accent);
    padding: 1rem 1.2rem; border-radius:16px;
    box-shadow:0 12px 36px rgba(212,175,55,.2);
    backdrop-filter: blur(10px);
  }
  .about .title{margin:.2rem 0 .5rem; color:#fff; font-weight:900; text-shadow: 0 2px 4px rgba(0,0,0,.3)}
  .about p{margin:0; color:#e9f5ef; font-size:1rem; line-height: 1.6}

  /* لوحة المنافسة المميزة */
  .leaderboard-card {
    background: linear-gradient(135deg, 
      rgba(255,215,0,.08), 
      rgba(255,193,7,.05), 
      rgba(255,152,0,.03)
    ) !important;
    border: 2px solid rgba(255,215,0,.3) !important;
    box-shadow: 0 20px 60px rgba(255,215,0,.15) !important;
    position: relative;
    overflow: hidden;
  }
  
  .leaderboard-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, 
      transparent, 
      rgba(255,215,0,.1), 
      transparent
    );
    animation: shimmer 3s ease-in-out infinite;
    pointer-events: none;
  }
  
  @keyframes shimmer {
    0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  }
  
  .leaderboard-card h3 {
    color: #ffd700 !important;
    text-shadow: 0 2px 8px rgba(255,215,0,.3) !important;
  }
  
  .rank-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.8rem 0;
    padding: 0.6rem 1rem;
    background: linear-gradient(135deg, rgba(255,215,0,.15), rgba(255,193,7,.1));
    border: 1px solid rgba(255,215,0,.3);
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(255,215,0,.2);
  }
  
  .rank-badge {
    color: #fff;
    font-weight: 700;
    font-size: 0.95rem;
  }
  
  .rank-badge strong {
    color: #ffd700;
    font-size: 1.1rem;
  }
  
  .medal {
    font-size: 1.5rem;
    animation: bounce 2s ease-in-out infinite;
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }
  
  .leaderboard-card .btn {
    background: linear-gradient(135deg, #ffd700, #ffb300) !important;
    color: #1a1a1a !important;
    border: none !important;
    font-weight: 900 !important;
    box-shadow: 0 6px 20px rgba(255,215,0,.4) !important;
    transition: all 0.3s ease !important;
  }
  
  .leaderboard-card .btn:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 10px 30px rgba(255,215,0,.6) !important;
    background: linear-gradient(135deg, #ffed4e, #ffd700) !important;
  }
</style>

<div class="home-shell">

  <section class="welcome welcome-animate">
    <!-- بادج الترحيب (الدوت في اليمين) -->
    <div class="chip animate-on-scroll animate-delay-1" style="margin-bottom:.55rem">
      <span class="dot" aria-hidden="true"></span>
      مرحبًا، {{ student.display_name|default:request.user.username|truncatewords:2|cut:"…" }}
      {% if my_rank and my_rank|add:0 <= 3 %}
        <span class="badge-medal">
          {% if my_rank == 1 %}🥇{% elif my_rank == 2 %}🥈{% else %}🥉{% endif %} #{{ my_rank }}
        </span>
      {% endif %}
    </div>

    <h1 class="animate-on-scroll animate-delay-2">متواتر — <span style="color:var(--accent)">Mutawatir</span></h1>
    <div class="title-underline animate-on-scroll animate-delay-3"></div>
    <p class="lead animate-on-scroll animate-delay-4">
      منصة متطورة لاختبار وتثبيت حفظ القرآن، وترسيخ صورة المصحف في الذاكرة.
    </p>

    <div class="home-cta">
      <!-- تم تغيير الوجهة إلى كتالوج الاختبارات -->
      <a href="/tests/" class="btn btn-primary btn-lg btn-animate animate-delay-5">بدء اختبار جديد</a>
      {% if request.session.questions %}
        <a href="{% url 'tests:tests_root' %}" class="btn btn-outline btn-lg btn-animate animate-delay-6">استكمال الاختبار الحالي</a>
      {% endif %}
      <a href="{% url 'core:complaint' %}" class="btn btn-outline btn-lg btn-animate animate-delay-6">إبلاغ / اقتراح</a>
      
    </div>
  </section>

<!-- الصف الأول - 3 مربعات متساوية -->
<section class="grid-cards" aria-label="الأقسام الرئيسية">
  <!-- اختبارات الحفظ -->
  <article class="cardx card-animate animate-delay-1">
    <h3>📚 اختبارات الحفظ</h3>
    <p>اختر نوع الاختبار، ثم حدّد النطاق (أجزاء، أرباع، أو سور)، وابدأ.</p>
    <a href="/tests/" class="btn btn-primary go">ابدأ الآن</a>
  </article>

  <!-- لوحة المنافسة -->
  <article class="cardx card-animate animate-delay-2 leaderboard-card">
    <h3>🏆 لوحة المنافسة</h3>
    <p>شاهد ترتيب الطلاب حسب الأداء والنشاط في المنصة.</p>
    {% if my_rank %}
      <div class="rank-display">
        <span class="rank-badge">ترتيبك الحالي: <strong>#{{ my_rank }}</strong></span>
        {% if my_rank|add:0 <= 3 %}
          <span class="medal">{% if my_rank == 1 %}🥇{% elif my_rank == 2 %}🥈{% else %}🥉{% endif %}</span>
        {% endif %}
      </div>
    {% endif %}
               <a href="{% url 'stats_app:leaderboard' %}" class="btn btn-primary go">فتح اللوحة</a>
  </article>

  <!-- إحصائياتك -->
  <article class="cardx card-animate animate-delay-3">
    <h3>📊 إحصائياتك</h3>

    <style>
      .stats-tiles{
        display:grid;
        grid-template-columns:repeat(4,1fr);
        gap:.6rem;
        margin:.4rem 0 .6rem;
      }
      @media(max-width:700px){ .stats-tiles{grid-template-columns:repeat(2,1fr)} }
      @media(max-width:540px){ .stats-tiles{grid-template-columns:1fr} }
      
      .tile{
        background:#0f1118;
        border:1px solid rgba(255,255,255,.10);
        border-radius:14px;
        padding:.8rem .9rem;
        text-align:center;
        box-shadow:0 10px 28px rgba(0,0,0,.18);
        display:grid;
        gap:4px;
        transition: all 0.3s ease;
      }
      
      .tile:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(0,0,0,.25);
      }
      
      .tile .v{
        display:block; 
        font-weight:900; 
        font-size:clamp(22px,4.6vw,28px); 
        color:#fff;
        font-size:1.6rem;
      }
      
      .tile .k{
        display:block; 
        font-weight:800; 
        color:#c8d1cf; 
        margin-top:.2rem; 
        font-size:.95rem;
      }
      
      /* نفس ألوان صفحة /stats/ */
      .tile.ok .v{ color:#22c55e }
      .tile.no .v{ color:#ef4444 }
      .tile.muted .v{ color:#e5d18f }
    </style>

    <div class="stats-tiles">
      <div class="tile muted stat-animate animate-delay-1"><span class="v">{{ stats.exams }}</span><span class="k">امتحانات</span></div>
      <div class="tile ok stat-animate animate-delay-2"><span class="v">{{ stats.correct }}</span><span class="k">صحيح</span></div>
      <div class="tile no stat-animate animate-delay-3"><span class="v">{{ stats.wrong }}</span><span class="k">خطأ</span></div>
      <div class="tile stat-animate animate-delay-4"><span class="v">{{ stats.unanswered }}</span><span class="k">غير مُجاب</span></div>
    </div>

               <a href="{% url 'stats_app:stats' %}" class="btn btn-outline go">عرض تفصيلي</a>
  </article>
</section>

<!-- الصف الثاني - مربعين متساويين -->
<section class="grid-cards-two" aria-label="الأقسام الثانوية">
  <!-- حسابك -->
  <article class="cardx card-animate animate-delay-4">
    <h3>👤 حسابك</h3>
    <p>اسم العرض: <strong>{{ student.display_name|default:request.user.username }}</strong></p>
    {% if request.user.email %}
      <p>البريد: <strong>{{ request.user.email }}</strong></p>
    {% endif %}
    <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.35rem">
      <a href="{% url 'core:account_settings' %}" class="btn btn-primary">تعديل معلومات الحساب</a>
      <a href="{% url 'core:logout' %}" class="btn btn-outline">تسجيل الخروج</a>
      {% if request.session.questions %}
        <a href="{% url 'tests:tests_root' %}" class="btn btn-outline">متابعة الاختبار</a>
      {% endif %}
    </div>
  </article>

  <!-- الإبلاغ والملاحظات -->
  <article class="cardx card-animate animate-delay-5">
    <h3>💬 الإبلاغ والملاحظات</h3>
    <p>واجهت مشكلة أو عندك اقتراح لتحسين التجربة؟ شاركنا رأيك لنحسّن المنصة باستمرار.</p>
    <a href="{% url 'core:complaint' %}" class="btn btn-outline go">إرسال ملاحظة</a>
  </article>
</section>

  <section class="about" aria-labelledby="about-title">
    <h2 id="about-title" class="title">عن متواتر</h2>
    <p>
      "متواتر" منصة تفاعلية مبتكرة تهدف إلى مساعدة حفظة القرآن الكريم على اختبار وتقوية حفظهم،
      مع التركيز على الآيات المتشابهة. توفر للمستخدمين اختبارات دقيقة تُبنى على اختيارهم للأجزاء أو الأرباع أو السور،
      مع عرض النتائج والتقييمات التفصيلية، مما يساعد على التثبيت وترسيخ صورة المصحف في الذاكرة.
    </p>
  </section>

</div>

<!-- إخفاء أي "مرحب" في الهيدر بجوار "تسجيل الخروج" على هذه الصفحة فقط -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
    function hideNavWelcome(){
      var containers = document.querySelectorAll('header, nav, .navbar, .topbar, .site-header');
      containers.forEach(function(h){
        var hasLogout = /(تسجيل الخروج|Log ?out)/.test((h.textContent||'')); if(!hasLogout) return;
        h.querySelectorAll('*').forEach(function(el){
          if(el.children.length===0){
            var t=(el.textContent||'').trim();
            if(/مرحب/.test(t)){ el.style.display='none'; }
          }
        });
      });
    }
    hideNavWelcome();
    new MutationObserver(hideNavWelcome).observe(document.body,{subtree:true,childList:true});
  });
</script>

<!-- JavaScript لتفعيل الانيميشن -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // تفعيل الانيميشن عند التمرير
  function animateOnScroll() {
    const elements = document.querySelectorAll('.animate-on-scroll, .card-animate, .stat-animate, .btn-animate, .welcome-animate');
    
    elements.forEach(element => {
      const elementTop = element.getBoundingClientRect().top;
      const elementVisible = 150;
      
      if (elementTop < window.innerHeight - elementVisible) {
        element.classList.add('animate-in');
      }
    });
  }
  
  // تفعيل الانيميشن عند التحميل
  setTimeout(() => {
    animateOnScroll();
  }, 100);
  
  // تفعيل الانيميشن عند التمرير
  window.addEventListener('scroll', animateOnScroll);
  
  // تفعيل انيميشن الترحيب فوراً
  const welcomeSection = document.querySelector('.welcome-animate');
  if (welcomeSection) {
    setTimeout(() => {
      welcomeSection.classList.add('animate-in');
    }, 200);
  }
  
  // تفعيل انيميشن البطاقات تدريجياً
  const cards = document.querySelectorAll('.card-animate');
  cards.forEach((card, index) => {
    setTimeout(() => {
      card.classList.add('animate-in');
    }, 400 + (index * 200));
  });
  
  // تفعيل انيميشن الإحصائيات تدريجياً
  const stats = document.querySelectorAll('.stat-animate');
  stats.forEach((stat, index) => {
    setTimeout(() => {
      stat.classList.add('animate-in');
    }, 600 + (index * 100));
  });
  
  // تفعيل انيميشن الأزرار تدريجياً
  const buttons = document.querySelectorAll('.btn-animate');
  buttons.forEach((button, index) => {
    setTimeout(() => {
      button.classList.add('animate-in');
    }, 800 + (index * 150));
  });
});

// انيميشن إضافي للعناصر عند التمرير
function addScrollAnimations() {
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0) scale(1)';
      }
    });
  }, observerOptions);
  
  // مراقبة جميع العناصر المتحركة
  const animatedElements = document.querySelectorAll('.card-animate, .stat-animate, .btn-animate');
  animatedElements.forEach(el => observer.observe(el));
}

// تفعيل الانيميشن عند التمرير
window.addEventListener('load', addScrollAnimations);

// دالة اختبار الإشعارات

</script>

{% endblock %}



