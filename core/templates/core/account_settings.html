{% extends "core/base.html" %}
{% load static i18n %}

{% block title %}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ â€” Ù…ØªÙˆØ§ØªØ±{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/account_settings.css' %}">
<style>
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.avatar-lg {
    position: relative;
    overflow: hidden;
}
</style>
{% endblock %}

{% block content %}
<div class="acc-wrap">
  <!-- Back Button -->
  <div class="back-button-container">
    <a href="{% url 'core:main_menu' %}" class="btn-back">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Profile Settings -->
  <div class="acc-card">
    <h2 class="acc-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
    <p class="acc-subtitle">Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</p>
    
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_profile">
      
      <!-- Avatar Section -->
      <div class="avatar-section">
        <div class="avatar-lg" id="avatar-preview">
          {% if student.avatar %}
            <img src="{{ student.avatar.url }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨">
          {% else %}
            <div class="avatar-fallback">{{ student.display_name|first|upper }}</div>
          {% endif %}
        </div>
        
        <div class="file-input-wrapper">
          <input type="file" name="avatar" id="id_avatar" accept="image/*" class="form-control">
          <label for="id_avatar" class="file-input-button">
            ğŸ“· ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
          </label>
        </div>
        
        {% if student.avatar %}
        <div class="remove-avatar-section">
          <button type="button" class="btn-remove-avatar" onclick="showDeleteConfirm()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
        </div>
        {% endif %}
      </div>

      <!-- Display Name -->
      <div class="form-group">
        <label for="id_display_name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
        <input type="text" name="display_name" id="id_display_name" class="form-control" 
               value="{{ profile_form.display_name.value|default:student.display_name }}" 
               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="id_email" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" name="email" id="id_email" class="form-control" 
               value="{{ profile_form.email.value|default:student.user.email }}" 
               placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¨Ø±ÙŠØ¯</div>
      </div>

      <!-- Skin Selection -->
      <div class="form-group">
        <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¸Ù‡Ø±</label>
        <div class="skin-grid">
          {% for value, label in profile_form.skin.field.choices %}
            <div class="skin-option {% if value == student.skin %}selected{% endif %}">
              <input type="radio" name="skin" value="{{ value }}" id="skin_{{ value }}" 
                     {% if value == student.skin %}checked{% endif %}>
              <label for="skin_{{ value }}">
                <img src="{% static 'img/skins/'|add:value|add:'.jpg' %}" 
                     alt="Ù…Ø¸Ù‡Ø± {{ label }}" class="skin-preview">
                <div class="skin-info">{{ label }}</div>
              </label>
            </div>
          {% endfor %}
        </div>
        <div class="hint">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø°ÙŠ ØªÙØ¶Ù„Ù‡ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©</div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn-lg btn-primary" id="save-profile-btn" disabled>
          ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        </button>
      </div>
    </form>
  </div>

  <!-- Password Change -->
  <div class="acc-card">
    <h2 class="acc-title">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
    <p class="acc-subtitle">Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ù…Ø§ÙŠØ© Ø­Ø³Ø§Ø¨Ùƒ</p>
    
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="change_password">
      
      <div class="form-group">
        <label for="id_current_password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
        <input type="password" name="current_password" id="id_current_password" class="form-control" 
               placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" required>
      </div>

      <div class="form-group">
        <label for="id_new_password" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <input type="password" name="new_password" id="id_new_password" class="form-control" 
               placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required minlength="8">
      </div>

      <div class="form-group">
        <label for="id_confirm_password" class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <input type="password" name="confirm_password" id="id_confirm_password" class="form-control" 
               placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-lg btn-primary" id="save-password-btn" disabled>
          ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© -->
<div id="deleteConfirmModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</h3>
    </div>
    <div class="modal-body">
      <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ</p>
      <p class="modal-warning">âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" onclick="hideDeleteConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
      <button type="button" class="btn-confirm-delete" onclick="confirmRemoveAvatar()">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Modal functions
function showDeleteConfirm() {
    const modal = document.getElementById('deleteConfirmModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideDeleteConfirm() {
    const modal = document.getElementById('deleteConfirmModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function confirmRemoveAvatar() {
    const form = document.querySelector('form input[name="action"][value="update_profile"]').closest('form');
    if (!form) return;
    
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'remove_avatar';
    hiddenInput.value = '1';
    form.appendChild(hiddenInput);
    
    hideDeleteConfirm();
    form.submit();
}

function clearEmail() {
    const emailInput = document.getElementById('id_email');
    if (emailInput) {
        emailInput.value = '';
        emailInput.focus();
    }
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
function setupImagePreview() {
    const avatarInput = document.getElementById('id_avatar');
    const avatarPreview = document.getElementById('avatar-preview');
    
    if (avatarInput && avatarPreview) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
                if (!file.type.startsWith('image/')) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ØµØ§Ù„Ø­');
                    this.value = '';
                    return;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    avatarPreview.innerHTML = '';
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '50%';
                    
                    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø§Ø¹Ù…
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease';
                    
                    avatarPreview.appendChild(img);
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
                    setTimeout(() => {
                        img.style.opacity = '1';
                    }, 10);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± "Ø¬Ø¯ÙŠØ¯"
                    const newBadge = document.createElement('div');
                    newBadge.innerHTML = 'ğŸ†•';
                    newBadge.style.position = 'absolute';
                    newBadge.style.top = '5px';
                    newBadge.style.right = '5px';
                    newBadge.style.background = 'rgba(34, 197, 94, 0.9)';
                    newBadge.style.color = 'white';
                    newBadge.style.borderRadius = '50%';
                    newBadge.style.width = '24px';
                    newBadge.style.height = '24px';
                    newBadge.style.display = 'flex';
                    newBadge.style.alignItems = 'center';
                    newBadge.style.justifyContent = 'center';
                    newBadge.style.fontSize = '12px';
                    newBadge.style.zIndex = '10';
                    newBadge.style.animation = 'pulse 2s infinite';
                    
                    avatarPreview.appendChild(newBadge);
                    
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
                    setTimeout(() => {
                        if (newBadge.parentNode) {
                            newBadge.parentNode.removeChild(newBadge);
                        }
                    }, 3000);
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Ø¥Ø¯Ø§Ø±Ø© ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸
function checkFormChanges() {
    const profileForm = document.querySelector('form input[name="action"][value="update_profile"]').closest('form');
    const passwordForm = document.querySelector('form input[name="action"][value="change_password"]').closest('form');
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    if (profileForm) {
        const saveBtn = document.getElementById('save-profile-btn');
        const inputs = profileForm.querySelectorAll('input[type="text"], input[type="email"], input[type="file"], input[type="radio"]');
        
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                saveBtn.disabled = false;
            });
            input.addEventListener('change', () => {
                saveBtn.disabled = false;
            });
        });
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if (passwordForm) {
        const saveBtn = document.getElementById('save-password-btn');
        const inputs = passwordForm.querySelectorAll('input[type="password"]');
        
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                const allFilled = Array.from(inputs).every(inp => inp.value.trim() !== '');
                saveBtn.disabled = !allFilled;
            });
        });
    }
}

// Event listeners
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') hideDeleteConfirm();
});

document.getElementById('deleteConfirmModal')?.addEventListener('click', function(e) {
    if (e.target === this) hideDeleteConfirm();
});

// ØªÙØ¹ÙŠÙ„ ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    checkFormChanges();
    setupImagePreview();
});
</script>
{% endblock %}
